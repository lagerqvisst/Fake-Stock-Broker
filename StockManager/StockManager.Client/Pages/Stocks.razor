@page "/Stocks"
@rendermode InteractiveAuto
@using BusinessLayer
@using Models
@using System.Text.Json

<PageTitle>Stocks</PageTitle>


<img id="headerimg" src="FUNANZA.png"/>


<StockSearch></StockSearch>



<button id="portfolioBtn"  @onclick="ShowPortfolio">Show Portfolio</button>

    @if(ShowPortFolio && user.portfolio.Stocks.Count > 0)
    {
        <h1>Portfolio</h1>
        <p id="portfolioValue"> Total value: @user.portfolio.PortfolioValue</p>
        <p id="funds"> Available funds: @user.portfolio.AvailableFunds</p>
        <table id="Portfolio">
            <tr>
                <th>Namn</th>
                <th>Ticker</th>
                <th>Previous close</th>
                <th>Quantity</th>
                <th>Total Value</th>
                <th>#</th>
                <th>ACTION</th>


            </tr>
            @foreach (Stock stock in user.portfolio.Stocks)
            {
                <tr>
                    <td>@stock.Name</td>
                    <td>@stock.Ticker</td>
                    <td>@stock.Price</td>
                    <td>@stock.Quantity</td>
                    <td>@stock.totalValue</td>
                    <td>
                        <input type="number" name="quantity" min="1" @bind="quantityInput">
                    </td>
                    <td>
						<button id="sellBtn" @onclick="@(e => user.portfolio.SellStock(stock, quantityInput))">SELL</button>
                    </td>

                </tr>
            }
        </table>
    }
else if (ShowPortFolio)
{
    <h1>Portfolio</h1>
    <p> Total value: </p>
    <p> Available funds: @user.portfolio.AvailableFunds</p>
    <table id="Portfolio">
        <tr>
            <th>Namn</th>
            <th>Ticker</th>
            <th>Previous close</th>
            <th>Quantity</th>
        </tr>

            <tr>
                <td>stock name</td>
                <td>ticker</td>
                <td>.price</td>
                <td>#</td>
            </tr>

    </table>
	}


@code {

    private bool ShowPortFolio = false;

    private async Task<decimal> previousClose(string ticker)
    {
        return await yahooAPI.StockPricePreviousClose(ticker);
    }

    private int quantityInput;
    private Dictionary<string, int> quantities = new Dictionary<string, int>();
    private YahooAPI yahooAPI = new YahooAPI();
    private string searchInput;
    private List<Stock> stocksTest = new List<Stock>();
    private bool isDataLoaded = false;
    private User user = new User("admin" , "admin");






    private void ShowPortfolio()
	{
		ShowPortFolio = true;
	}
    private async Task SearchForStock()
    {
        Console.WriteLine("GenerateTestData() called");
        stocksTest = await yahooAPI.GetStocks(searchInput);
        foreach (var stock in stocksTest)
        {
            stock.Price = await previousClose(stock.Ticker); // Uppdatera stängningspriset för varje aktie
        }
        isDataLoaded = true;
        Console.WriteLine("Data loaded, updating view");
        StateHasChanged(); // Uppdatera vyn efter att isDataLoaded har ändrats
    }
}
